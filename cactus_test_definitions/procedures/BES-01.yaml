Description: Individual readings - storage
Category: Monitoring
Classes:
  - L

Criteria:
  checks:
    - type: all-steps-complete
      parameters: {}

    # Test includes ~ 5 minutes of waiting + initial reading sent during test
    # A minimum of 5 readings is required by the test procedure
    - type: readings-der-stored-energy
      parameters: { "minimum_count": 5 }

Preconditions:
  actions:
    - type: set-comms-rate
      parameters:
        der_list_poll_seconds: 60
        mup_post_seconds: 60

    # Placeholder for later controls
    - type: create-der-program
      parameters: 
        primacy: 1
        fsa_id: 1

Steps:
  GET-MUP:
    event:
      type: GET-request-received
      parameters:
        endpoint: /mup
    actions:
      - type: enable-steps
        parameters:
          steps:
            - POST-MUP
      - type: remove-steps
        parameters:
          steps:
            - GET-MUP

  POST-MUP:
    event:
      type: POST-request-received
      parameters:
        endpoint: /mup
    actions:
      - type: enable-steps
        parameters:
          steps:
            - GET-MUP-2
      - type: remove-steps
        parameters:
          steps:
            - POST-MUP

  GET-MUP-2:
    event:
      type: GET-request-received
      parameters:
        endpoint: /mup
    actions:
      - type: enable-steps
        parameters:
          steps:
            - WAIT-READINGS
      - type: remove-steps
        parameters:
          steps:
            - GET-MUP-2

  # Wait for at least 2 readings to arrive
  WAIT-READINGS:
    event:
      type: wait
      parameters:
        duration_seconds: 180 # Wait for at least 2 sets of readings to arrive (with post rate 60 seconds)
    actions:
      - type: enable-steps
        parameters:
          steps:
            - GET-DERC
      - type: remove-steps
        parameters:
          steps:
            - WAIT-READINGS

  # On this poll, client will discover new 0W control is in place
  GET-DERC:
    event:
      type: GET-request-received
      parameters:
        endpoint: /edev/1/derp/1/derc
    actions:
      - type: create-der-control
        parameters:
          start: $(now)
          duration_seconds: 600
          opModStorageTargetW: 0
      - type: enable-steps
        parameters:
          steps:
            - WAIT-CONTROL
      - type: remove-steps
        parameters:
          steps:
            - GET-DERC

  # This just lets the test run for a few more posts after the control comes into effect
  # after which, we will force the test to shutdown (as Criteria is partially defined by this ONLY running for a few posts)
  WAIT-CONTROL:
    event:
      type: wait
      parameters:
        duration_seconds: 180 # Wait for at least 3 sets of readings to arrive (with post rate 60 seconds)
    actions:
      - type: remove-steps
        parameters:
          steps:
            - WAIT-CONTROL
      - type: finish-test
        parameters: {}
