Description: Response to Changing Ramp-Rates
Category: DER
Classes:
  - DER-A

TargetVersions:
  - v1.2
  - v1.3-beta/storage

Criteria:
  checks:
    - type: all-steps-complete
      parameters: {}

Preconditions:
  init_actions:
    - type: set-comms-rate
      parameters:
        dcap_poll_seconds: 60
        edev_list_poll_seconds: 60
        fsa_list_poll_seconds: 60
        der_list_poll_seconds: 60
        derp_list_poll_seconds: 60
        mup_post_seconds: 60
  checks:
    - type: end-device-contents
      parameters: {}
    - type: der-settings-contents
      parameters: {}
  actions:
    - type: create-der-program
      parameters:
        primacy: 0  
    - type: set-default-der-control
      parameters:
        opModImpLimW: 0
        opModExpLimW: 0
  instructions:
    - DER is exporting or importing at the connection point at least 50% of its rated power.

Steps:
  # (precondition)
  PRECONDITION-STARTUP:
    instructions:
      - This step is to give time for the DER to start importing/exporting at least 50% of its rated power.
    event:
      type: GET-request-received
      parameters:
        endpoint: /edev/1/derp/1/derc
    actions:
      - type: create-der-control
        parameters:
          start: $(now)
          duration_seconds: 240
          opModExpLimW: $(setMaxW * 2)
          opModImpLimW: $(setMaxW * 2)
      - type: enable-steps
        parameters:
          steps:
            - PRECONDITION-STARTUP-WAIT
      - type: remove-steps
        parameters:
          steps:
            - PRECONDITION-STARTUP
  
  # (precondition)
  PRECONDITION-STARTUP-WAIT:
    instructions:
      - This step is to give time for the DER to start importing/exporting at least 50% of its rated power.
    event:
      type: wait
      parameters:
        duration_seconds: 120
    actions:
      - type: enable-steps
        parameters:
          steps:
            - GET-DERC-1
      - type: remove-steps
        parameters:
          steps:
            - PRECONDITION-STARTUP-WAIT

  # (precondition)
  GET-DERC-1:
    event:
      type: GET-request-received
      parameters:
        endpoint: /edev/1/derp/1/derc
    actions:
      - type: create-der-control
        parameters:
          start: $(now)
          duration_seconds: 900
          opModExpLimW: $(setMaxW * 0.3)
          opModImpLimW: $(setMaxW * 0.3)
      - type: enable-steps
        parameters:
          steps:
            - GET-DERC-2
      - type: remove-steps
        parameters:
          steps:
            - GET-DERC-1

  # (a, b)
  GET-DERC-2:
    event:
      type: GET-request-received
      parameters:
        endpoint: /edev/1/derp/1/derc
    actions:
      - type: create-der-control
        parameters:
          start: $(now)
          duration_seconds: 300
          opModExpLimW: $(setMaxW * 0.1)
          opModImpLimW: $(setMaxW * 0.1)
      - type: enable-steps
        parameters:
          steps:
            - GET-DERC-3
      - type: remove-steps
        parameters:
          steps:
            - GET-DERC-2

  # (c, d)
  GET-DERC-3:
    event:
      type: GET-request-received
      parameters:
        endpoint: /edev/1/derp/1/derc
    actions:
      - type: create-der-control
        parameters:
          start: $(now)
          duration_seconds: 600 # Extra long but will be cancelled (give clients enough time to see cancellation)
          opModExpLimW: $(setMaxW * 0.5)
          opModImpLimW: $(setMaxW * 0.5)
          ramp_time_seconds: 60
      - type: enable-steps
        parameters:
          steps:
            - GET-DEFAULT-DERC
      - type: remove-steps
        parameters:
          steps:
            - GET-DERC-3

  # (e)
  GET-DEFAULT-DERC:
    event:
      type: GET-request-received
      parameters:
        endpoint: /edev/1/derp/1/dderc
    actions:
      - type: set-default-der-control
        parameters:
          setGradW: 100 # hundredths of a percent - this is 1%
          opModImpLimW: 0
          opModExpLimW: 0
      - type: enable-steps
        parameters:
          steps:
            - PUT-DERSETTINGS-SET-GRAD-W
      - type: remove-steps
        parameters:
          steps:
            - GET-DEFAULT-DERC

  # (f, g)
  PUT-DERSETTINGS-SET-GRAD-W:
    event:
      type: PUT-request-received
      parameters:
        endpoint: /edev/1/der/1/derg
        serve_request_first: true # Run this AFTER server receives the request
      checks:
        - type: der-settings-contents
          parameters:
            setGradW: 100
    actions:
      - type: cancel-active-der-controls
        parameters: {}
      - type: enable-steps
        parameters:
          steps:
            - POST-RESPONSE-CANCELLED
      - type: remove-steps
        parameters:
          steps:
            - PUT-DERSETTINGS-SET-GRAD-W

  # (h)
  POST-RESPONSE-CANCELLED:
    event:
      type: POST-request-received
      parameters:
        endpoint: /edev/1/rsps/site_control/rsp
        serve_request_first: true
      checks:
        - type: response-contents
          parameters: 
            latest: true
            status: 6
    actions:
      - type: enable-steps
        parameters:
          steps:
            - WAIT-RAMP
      - type: remove-steps
        parameters:
          steps:
            - POST-RESPONSE-CANCELLED

  # (i)
  WAIT-RAMP:
    event:
      type: wait
      parameters:
        duration_seconds: 120
    actions:
      - type: enable-steps
        parameters:
          steps:
            - GET-DERC-4
      - type: remove-steps
        parameters:
          steps:
            - WAIT-RAMP
    instructions:
      - The DER shall reduce export/import to the current DefaultDERControl limit of 0W at the new ramp rate of 1 %/s.

  # (j)
  GET-DERC-4:
    event:
      type: GET-request-received
      parameters:
        endpoint: /edev/1/derp/1/derc
    actions:
      - type: create-der-control
        parameters:
          start: $(now)
          duration_seconds: 300
          opModExpLimW: $(setMaxW * 0.3)
          opModImpLimW: $(setMaxW * 0.3)
      - type: enable-steps
        parameters:
          steps:
            - POST-RESPONSE-STARTED
      - type: remove-steps
        parameters:
          steps:
            - GET-DERC-4

  # (k)
  POST-RESPONSE-STARTED:
    event:
      type: POST-request-received
      parameters:
        endpoint: /edev/1/rsps/site_control/rsp
        serve_request_first: true
      checks:
        - type: response-contents
          parameters: 
            latest: true
            status: 2
    actions:
      - type: remove-steps
        parameters:
          steps:
            - POST-RESPONSE-STARTED