Description: Subscribe
Category: Control
Classes:
  - S

TargetVersions:
  - v1.2
  - v1.3-beta/storage

Criteria:
  checks:
    - type: all-steps-complete
      parameters: {}
    - type: all-notifications-transmitted
      parameters: {}

Preconditions:
  immediate_start: true # There will be no "init" phase - all interactions will be immediately logged against the test
  init_actions:
    - type: set-comms-rate
      parameters:
        dcap_poll_seconds: 60
        edev_list_poll_seconds: 60
        fsa_list_poll_seconds: 60
        der_list_poll_seconds: 60
        derp_list_poll_seconds: 60
        mup_post_seconds: 60

  actions:  
    - type: create-der-program
      parameters:
        primacy: 0
    # Start by enabling everything at the beginning as each step is (mostly) independent of the others
    - type: enable-steps
      parameters:
        steps:
            - POST-SUBSCRIPTION-FSAL
            - POST-SUBSCRIPTION-DERP
            - POST-SUBSCRIPTION-DERC
            - POST-SUBSCRIPTION-DEFAULT-DERC

Steps:

  # (a, b, c, d, e, f)
  # Wait for a subscription to EndDeviceList and then update the active EndDevice's postRate to trigger a notification
  POST-SUBSCRIPTION-EDEV:
    instructions:
      - Trigger an EndDeviceList subscription request from the aggregator client system (this can be an automated response to completing the Discovery process).
    event:
      type: POST-request-received
      parameters:
        endpoint: /edev/1/sub
        serve_request_first: true
      checks:
        - type: subscription-contents
          parameters: 
            subscribed_resource: /edev
    actions:
      # Trigger notification
      - type: set-comms-rate
        parameters:
          edev_post_seconds: 30
      - type: remove-steps
        parameters:
          steps:
            - POST-SUBSCRIPTION-EDEV

  # (g, h, i, j, k, l)
  # Wait for a subscription to FunctionSetAssignmentList and then update the active fsa list to trigger a notification
  POST-SUBSCRIPTION-FSAL:
    instructions:
      - Trigger a FunctionSetAssignmentsList subscription request from the aggregator client system.
    event:
      type: POST-request-received
      parameters:
        endpoint: /edev/1/sub
        serve_request_first: true
      checks:
        - type: subscription-contents
          parameters: 
            subscribed_resource: /edev/1/fsa
    actions:
      # Trigger notification
      - type: set-comms-rate
        parameters:
          fsa_list_poll_seconds: 30
      - type: remove-steps
        parameters:
          steps:
            - POST-SUBSCRIPTION-FSAL

  # (m, n, o, p, q, r)
  # Wait for a DERProgram subscription and then update the active DERProgram list to trigger a notification
  POST-SUBSCRIPTION-DERP:
    instructions:
      - Trigger a DERProgramList subscription request from the aggregator client system.
    event:
      type: POST-request-received
      parameters:
        endpoint: /edev/1/sub
        serve_request_first: true
      checks:
        - type: subscription-contents
          parameters: 
            subscribed_resource: /edev/1/fsa/1/derp
    actions:
      # Trigger notification
      - type: create-der-program
        parameters:
          primacy: 99
      - type: remove-steps
        parameters:
          steps:
            - POST-SUBSCRIPTION-DERP

  # (s, t, u, v, w, x)
  # Wait for a subscription to /edev/1/derp/1/derc and then create a DERControl to trigger a notification
  POST-SUBSCRIPTION-DERC:
    instructions:
      - Trigger a DERControlList subscription request from the aggregator client system.
    event:
      type: POST-request-received
      parameters:
        endpoint: /edev/1/sub
        serve_request_first: true
      checks:
        - type: subscription-contents
          parameters: 
            subscribed_resource: /edev/1/derp/1/derc
    actions:
      # Trigger notification
      - type: create-der-control
        parameters:
          start: $(now)
          duration_seconds: 600
          primacy: 0
          opModExpLimW: 0
      - type: remove-steps
        parameters:
          steps:
            - POST-SUBSCRIPTION-DERC

  # (y, z, aa, bb, cc)
  # Wait for a subscription to /edev/1/derp/1/dderc and then update the DefaultDERControl to trigger a notification
  POST-SUBSCRIPTION-DEFAULT-DERC:
    instructions:
      - Trigger a DefaultDERControl subscription request from the aggregator client system.
    event:
      type: POST-request-received
      parameters:
        endpoint: /edev/1/sub
        serve_request_first: true
      checks:
        - type: subscription-contents
          parameters: 
            subscribed_resource: /edev/1/derp/1/dderc
    actions:
      # Trigger notification
      - type: set-default-der-control
        parameters:
          opModImpLimW: 1234
      - type: remove-steps
        parameters:
          steps:
            - POST-SUBSCRIPTION-DEFAULT-DERC
