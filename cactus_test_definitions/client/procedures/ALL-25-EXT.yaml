Description: Extended operations
Category: DER
Classes:
  - A
  - DR-A

TargetVersions:
  - v1.2
  - v1.3-beta/storage

Criteria:
  checks:
    - type: all-steps-complete
      parameters: {}
    - type: response-contents
      parameters:
        all: true
        status: 1 # Received
    - type: response-contents
      parameters:
        all: true
        status: 2 # Started
    - type: response-contents
      parameters:
        all: true
        status: 3 # Completed
    - type: readings-site-active-power
      parameters: {"minimum_count": 70} # This test is 72 hours at 1 hour post rate

Preconditions:
  init_actions:
    # We will be slowing down the comms significantly due to the 72hour nature of this test
    - type: set-comms-rate
      parameters:
        dcap_poll_seconds: 3600
        edev_list_poll_seconds: 3600
        fsa_list_poll_seconds: 3600
        der_list_poll_seconds: 3600
        derp_list_poll_seconds: 3600
        mup_post_seconds: 3600

  checks:
    - type: end-device-contents
      parameters: {}
    

  actions:
    - type: create-der-program
      parameters:
        primacy: 0

    - type: set-default-der-control
      parameters:
        opModExpLimW: 0
        opModImpLimW: 0

Steps:

  # This will supply 24 hours of controls
  GET-DERC-DAY-1:
    event:
      type: GET-request-received
      parameters:
        endpoint: /edev/1/derp/1/derc
    actions:
      - type: create-der-control
        parameters:
          start: $(now)
          duration_seconds: 21600 # 6 hours
          opModExpLimW: $(setMaxW * 0.3)
          opModImpLimW: $(setMaxW * 0.3)
      - type: create-der-control
        parameters:
          start: $(now + '6 hours')
          duration_seconds: 21600 # 6 hours
          opModExpLimW: $(setMaxW * 1.2)
          opModImpLimW: $(setMaxW * 1.2)
      - type: create-der-control
        parameters:
          start: $(now + '12 hours')
          duration_seconds: 21600 # 6 hours
          opModExpLimW: $(setMaxW * 0.8)
          opModImpLimW: $(setMaxW * 0.8)
      - type: create-der-control
        parameters:
          start: $(now + '18 hours')
          duration_seconds: 21600 # 6 hours
          opModExpLimW: $(setMaxW * 0.1)
          opModImpLimW: $(setMaxW * 0.1)
      - type: enable-steps
        parameters:
          steps:
            - WAIT-DAY1-END
      - type: remove-steps
        parameters:
          steps:
            - GET-DERC-DAY-1

  # This will fire at the end of the first 24 hours
  WAIT-DAY1-END:
    instructions: 
      - Please note that this test will run continuously for 72 hours. You are currently in the first 24 hours.
      - New DERControls will be issued every 24 hours.
    event:
      type: wait
      parameters:
        duration_seconds: 86700 # 24 hours, 5 minutes (to ensure we don't supersede anything)
    actions:
      - type: create-der-control
        parameters:
          start: $(now)
          duration_seconds: 21600 # 6 hours
          opModExpLimW: $(setMaxW * 0.4)
          opModImpLimW: $(setMaxW * 0.4)
      - type: create-der-control
        parameters:
          start: $(now + '6 hours')
          duration_seconds: 21600 # 6 hours
          opModExpLimW: $(setMaxW * 1.5)
          opModImpLimW: $(setMaxW * 1.5)
      - type: create-der-control
        parameters:
          start: $(now + '12 hours')
          duration_seconds: 21600 # 6 hours
          opModExpLimW: $(setMaxW * 0.6)
          opModImpLimW: $(setMaxW * 0.6)
      - type: create-der-control
        parameters:
          start: $(now + '18 hours')
          duration_seconds: 21600 # 6 hours
          opModExpLimW: $(setMaxW * 0.2)
          opModImpLimW: $(setMaxW * 0.2)
      - type: enable-steps
        parameters:
          steps:
            - WAIT-DAY2-END
      - type: remove-steps
        parameters:
          steps:
            - WAIT-DAY1-END

  # This will fire at the end of the second 24 hours
  WAIT-DAY2-END:
    instructions: 
      - Please note that this test will run continuously for 72 hours. You are currently in the second 24 hours.
      - New DERControls will be issued every 24 hours.
    event:
      type: wait
      parameters:
        duration_seconds: 86700 # 24 hours, 5 minutes (to ensure we don't supersede anything)
    actions:
      - type: create-der-control
        parameters:
          start: $(now)
          duration_seconds: 21600 # 6 hours
          opModExpLimW: $(setMaxW * 0.5)
          opModImpLimW: $(setMaxW * 0.5)
      - type: create-der-control
        parameters:
          start: $(now + '6 hours')
          duration_seconds: 21600 # 6 hours
          opModExpLimW: $(setMaxW * 1)
          opModImpLimW: $(setMaxW * 1)
      - type: create-der-control
        parameters:
          start: $(now + '12 hours')
          duration_seconds: 21600 # 6 hours
          opModExpLimW: $(setMaxW * 0.3)
          opModImpLimW: $(setMaxW * 0.3)
      - type: create-der-control
        parameters:
          start: $(now + '18 hours')
          duration_seconds: 21600 # 6 hours
          opModExpLimW: $(setMaxW * 0.8)
          opModImpLimW: $(setMaxW * 0.8)
      - type: enable-steps
        parameters:
          steps:
            - WAIT-DAY3-END
      - type: remove-steps
        parameters:
          steps:
            - WAIT-DAY2-END

  # This will fire at the end of the test
  WAIT-DAY3-END:
    instructions: 
      - Please note that this test will run continuously for 72 hours. You are currently in the final 24 hours.
      - No more new controls will be issued after the current set. 
    event:
      type: wait
      parameters:
        duration_seconds: 86700 # 24 hours, 5 minutes
    actions:
      - type: enable-steps
        parameters:
          steps:
            - WAIT-TEST-END
      - type: remove-steps
        parameters:
          steps:
            - WAIT-DAY3-END

  # This will fire at the end of the test
  WAIT-TEST-END:
    instructions: 
      - The test is now complete - no more controls will be issued.
      - This delay is purely a chance to ensure that EVERY DERControl has received a "Completed (3)" Response.
      - This step will block indefinitely until the latest DERControl has a "Completed (3)" Response.
    event:
      type: wait
      parameters:
        duration_seconds: 10 # Token amount of time - we want this to start checking immediately
    checks:
      # This check will repeatedly fire after the wait time is met - this will ensure that a late "completed" response
      # won't waste 3 days of testing.
      - type: response-contents
        parameters:
          latest: true
          status: 3 
    actions:
      - type: remove-steps
        parameters:
          steps:
            - WAIT-TEST-END
      - type: finish-test
        parameters: {}
          