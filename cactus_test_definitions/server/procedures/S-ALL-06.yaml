Description: Mirror Usage Point Creation and Individual Readings
Category: Monitoring
Classes:
 - A

TargetVersions:
 - v1.2

Preconditions:
  required_clients:
    - id: client

Steps:
  - id: PRECONDITION
    repeat_until_pass: true
    instructions:
      - Create an EndDevice registration for client.
    action:
      type: discovery
      parameters:
        resources:
          - EndDevice
          - DeviceCapability
          - MirrorUsagePointList
          - DER
    checks:
      - type: end-device # This will be the check that will block UNTIL there is an existing EndDevice registration
        parameters:
          matches_client: true

  - id: 1 - DISCOVER INITIAL MUPS
    repeat_until_pass: true
    action: 
      type: discovery
      parameters:
        resources:
          - MirrorUsagePoint
    checks:
      - type: mirror-usage-point
        parameters:
          matches: false # MirrorUsagePoints must be initially empty for client.

  - id: 2,3A - CREATE MUP FOR SITE
    action: 
      type: upsert-mup
      parameters:
        mup_id: mup_site
        location: Site
        reading_types: 
          - ActivePowerAverage
          - ReactivePowerAverage
          - FrequencyAverage
          - VoltageSinglePhaseAverage
    checks:
      - type: mirror-usage-point
        parameters:
          location: Site
          matches: true
          reading_types: 
          - ActivePowerAverage
          - ReactivePowerAverage
          - FrequencyAverage
          - VoltageSinglePhaseAverage

  - id: 2,3B - CREATE MUP FOR DEVICE
    action: 
      type: upsert-mup
      parameters:
        mup_id: mup_device
        location: Device
        reading_types: 
          - ActivePowerAverage
          - ReactivePowerAverage
          - FrequencyAverage
          - VoltageSinglePhaseAverage
    checks:
      - type: mirror-usage-point
        parameters:
          location: Device
          matches: true
          reading_types: 
          - ActivePowerAverage
          - ReactivePowerAverage
          - FrequencyAverage
          - VoltageSinglePhaseAverage

  - id: 4A - POST READINGS TO SITE
    action: 
      type: insert-readings
      parameters:
        mup_id: mup_site
        values:
          ActivePowerAverage: [5000, 5100, 5200, 5300]
          ReactivePowerAverage: [1000, 1100, 1200, 1300]
          FrequencyAverage: [50.0, 50.1, 49.9, 50.0]
          VoltageSinglePhaseAverage: [230.0, 231.0, 229.0, 230.5]

  - id: 4B - POST READINGS TO DEVICE
    action: 
      type: insert-readings
      parameters:
        mup_id: mup_device
        values:
          ActivePowerAverage: [5000, 5100, 5200, 5300]
          ReactivePowerAverage: [1000, 1100, 1200, 1300]
          FrequencyAverage: [50.0, 50.1, 49.9, 50.0]
          VoltageSinglePhaseAverage: [230.0, 231.0, 229.0, 230.5]

  # NOTE: The final step of this test (5) is to verify that readings are retained correctly by the server.
  # As href is optional, it is assumed many servers will not currently support this.
  # While waiting for a discussion by the CIRG it has been decided to omit this step of testing for now.
