Description: Discovery with In-Band Registration for Aggregator Clients
Category: Registration
Classes:
 - A

TargetVersions:
 - v1.2

Preconditions:
  required_clients:
    - id: client
      client_type: aggregator
  
Steps:
  - id: PRECONDITION
    repeat_until_pass: true
    instructions:
      - Remove any existing EndDevice registrations for client.
    action: 
      type: discovery
      parameters:
        resources:
          - DeviceCapability
          - EndDevice
    checks:
      - type: discovered
        parameters:
          resources:
            - Time
            - MirrorUsagePointList
            - DeviceCapability
            - EndDeviceList
      - type: end-device # This will be the check that will block if there is an existing EndDevice registration
        parameters:
          matches_client: false 

  - id: REGISTER
    action: 
      type: insert-end-device
    checks:
      - type: end-device
        parameters:
          matches_client: true 

  - id: FETCHING DER INFO
    repeat_until_pass: true
    instructions:
      - Populate DERList with an entry that has a DERCapabilityLink, DERSettingsLink and DERStatusLink.
    action: 
      type: discovery
      parameters:
        resources:
          - Time
          - MirrorUsagePointList
          - DER
    checks:
      - type: discovered
        parameters:
          links:
            - DERCapability
            - DERSettings
            - DERStatus
      - type: time-synced
    
